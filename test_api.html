<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Lite API Tester</title>
    <style>
        body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; }
        .box { border: 1px solid #ccc; padding: 15px; margin-bottom: 20px; border-radius: 8px; }
        input, textarea, button { display: block; width: 100%; margin: 5px 0; padding: 8px; box-sizing: border-box; }
        button { cursor: pointer; background: #eee; border: 1px solid #999; }
        button:hover { background: #ddd; }
        pre { background: #333; color: #0f0; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>

    <h1>‚ö° –ë—ã—Å—Ç—Ä—ã–π —Ç–µ—Å—Ç API</h1>

    <div class="box">
        <h3>1. –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
        <input type="text" id="login" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <div style="display: flex; gap: 10px;">
            <button onclick="sendAuth('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button onclick="sendAuth('login')" style="background: #b3d7ff;">–í–æ–π—Ç–∏ (Login)</button>
        </div>
        <button onclick="sendAuth('get_users')">–°–ø–∏—Å–æ–∫ –ª—é–¥–µ–π</button>
    </div>

    <div class="box" style="border-color: green;">
        <h3>2. –°–æ–∑–¥–∞—Ç—å –∫–Ω–∏–≥—É</h3>
        <input type="text" id="bookTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏">
        <textarea id="bookText" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–∏–≥–∏"></textarea>
        <small>–ò–ª–∏ —Ñ–∞–π–ª .txt:</small>
        <input type="file" id="bookFile" accept=".txt">
        <button onclick="createBook()" style="background: #d4edda;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–Ω–∏–≥—É</button>
    </div>
    <div class="box" style="border-color: blue;">
        <h3>3. –ú–æ—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞</h3>
        <button onclick="getMyBooks()" style="background: #cce5ff;">üìö –ó–∞–≥—Ä—É–∑–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥</button>

        <div id="booksList" style="margin-top: 10px;"></div>
    </div>
    <div class="box" style="border-color: #ff9900;">
        <h3>4. –ü–æ–∏—Å–∫ –≤ Google Books</h3>
        <input type="text" id="googleQuery" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: PHP)">
        <button onclick="searchGoogle()" style="background: #ffcc80;">üîç –ù–∞–π—Ç–∏ –≤ Google</button>

        <div id="googleResults" style="margin-top: 15px;"></div>
    </div>
    <div class="box" style="border-color: purple;">
        <h3>5. –î–æ—Å—Ç—É–ø—ã (–°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å)</h3>

        <div style="margin-bottom: 15px; border-bottom: 1px dashed #ccc; padding-bottom: 10px;">
            <h4> –î–∞—Ç—å –¥–æ—Å—Ç—É–ø –¥—Ä—É–≥—É</h4>
            <input type="number" id="guestId" placeholder="ID –¥—Ä—É–≥–∞ (–ø—Ä–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –≤ –°–ø–∏—Å–∫–µ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤)">
            <button onclick="grantAccess()" style="background: #e0cffc;">–û—Ç–∫—Ä—ã—Ç—å –¥–æ—Å—Ç—É–ø</button>
        </div>

        <div>
            <h4> –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—É–∂—É—é –±–∏–±–ª–∏–æ—Ç–µ–∫—É</h4>
            <input type="number" id="ownerId" placeholder="ID –≤–ª–∞–¥–µ–ª—å—Ü–∞">
            <button onclick="viewOtherLibrary()" style="background: #e0cffc;">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∫–Ω–∏–≥–∏</button>
        </div>

        <div id="otherLibraryList" style="margin-top: 10px; font-style: italic;"></div>
    </div>

    <h3>–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:</h3>
    <pre id="out">–û–∂–∏–¥–∞–Ω–∏–µ...</pre>

    <script>
        // –§—É–Ω–∫—Ü–∏—è 1: –î–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏, –≤—Ö–æ–¥–∞ –∏ –ø–æ–ª—É—á–µ–Ω–∏—è —é–∑–µ—Ä–æ–≤
        async function sendAuth(method) {
            const login = document.getElementById('login').value;
            const pass = document.getElementById('pass').value;

            const res = await fetch(`api.php?method=${method}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ login: login, password: pass })
            });

            const data = await res.json();
            document.getElementById('out').innerText = JSON.stringify(data, null, 2);

            if (data.token) { // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –¥–∞–ª —Ç–æ–∫–µ–Ω - –∑–∞–ø–æ–º–∏–Ω–∞–µ–º
                localStorage.setItem('token', data.token);
                alert('–¢–æ–∫–µ–Ω –ø–æ–ª—É—á–µ–Ω! –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞–≤–∞—Ç—å –∫–Ω–∏–≥–∏.');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è 2: –î–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–Ω–∏–≥–∏ (—Å —Ñ–∞–π–ª–æ–º)
        async function createBook() {
            const token = localStorage.getItem('token');
            if (!token) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ (Login)!');

            const formData = new FormData();
            formData.append('title', document.getElementById('bookTitle').value);
            formData.append('text', document.getElementById('bookText').value);

            const file = document.getElementById('bookFile').files[0];
            if (file) formData.append('book_file', file);

            const res = await fetch('api.php?method=create_book', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                body: formData
            });

            const data = await res.json();
            document.getElementById('out').innerText = JSON.stringify(data, null, 2);
        }
        // –§—É–Ω–∫—Ü–∏—è 3: –ü–æ–ª—É—á–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥
        async function getMyBooks() {
            const token = localStorage.getItem('token');
            if (!token) return alert('–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ!');

            const res = await fetch('api.php?method=get_books', {
                method: 'GET', // –¢—É—Ç GET, —Ç–µ–ª–æ –Ω–µ –Ω—É–∂–Ω–æ
                headers: { 'Authorization': 'Bearer ' + token }
            });

            const data = await res.json();

            // –ö—Ä–∞—Å–∏–≤—ã–π –≤—ã–≤–æ–¥ JSON –≤ —á–µ—Ä–Ω–æ–µ –æ–∫–Ω–æ
            document.getElementById('out').innerText = JSON.stringify(data, null, 2);

            //–°–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫
            const listDiv = document.getElementById('booksList');
            listDiv.innerHTML = '';

            if (data.books && data.books.length > 0) {
                data.books.forEach(book => {
                    // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –∫–∞–∂–¥–æ–π –∫–Ω–∏–≥–∏
                    const btn = document.createElement('button');
                    btn.innerText = `üìñ ${book.title}`;
                    btn.style.margin = '5px 0';
                    btn.style.textAlign = 'left';
                    btn.onclick = () => openBook(book.id);
                    listDiv.appendChild(btn);
                });
            } else {
                listDiv.innerHTML = '<p>–ö–Ω–∏–≥ –ø–æ–∫–∞ –Ω–µ—Ç.</p>';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è 4: –û—Ç–∫—Ä—ã—Ç—å –æ–¥–Ω—É –∫–Ω–∏–≥—É (–ø–æ ID)
        async function openBook(id) {
            const token = localStorage.getItem('token');
            const res = await fetch(`api.php?method=get_book&id=${id}`, {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token }
            });
            const data = await res.json();
            document.getElementById('out').innerText = JSON.stringify(data, null, 2);
        }
        // –§—É–Ω–∫—Ü–∏—è 5: –ü–æ–∏—Å–∫ –≤ Google
        async function searchGoogle() {
            const q = document.getElementById('googleQuery').value;
            const res = await fetch(`api.php?method=search_external&q=${q}`);
            const data = await res.json();

            document.getElementById('out').innerText = JSON.stringify(data, null, 2);

            const listDiv = document.getElementById('googleResults');
            listDiv.innerHTML = '';

            if (data.items) {
                data.items.forEach(book => {
                    const div = document.createElement('div');
                    div.style.borderBottom = '1px solid #eee';
                    div.style.padding = '10px 0';
                    div.innerHTML = `
                        <strong>${book.title}</strong><br>
                        <small>${book.authors.join(', ')}</small><br>
                        <button onclick="saveFromGoogle('${escapeHtml(book.title)}', '${escapeHtml(book.description)}')"
                                style="font-size: 0.8em; padding: 5px; margin-top: 5px;">
                            üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫ —Å–µ–±–µ
                        </button>
                    `;
                    listDiv.appendChild(div);
                });
            }
        }

        // –§—É–Ω–∫—Ü–∏—è 6: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–Ω–æ–π –∫–Ω–∏–≥–∏
        // –ú—ã –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –≥–æ—Ç–æ–≤—ã–π –º–µ—Ç–æ–¥ create_book!
        async function saveFromGoogle(title, desc) {
            const token = localStorage.getItem('token');
            if (!token) return alert('–ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è!');

            const formData = new FormData();
            formData.append('title', title);
            formData.append('text', desc); // –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑ –≥—É–≥–ª–∞ —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è —Ç–µ–∫—Å—Ç–æ–º –∫–Ω–∏–≥–∏

            const res = await fetch('api.php?method=create_book', {
                method: 'POST',
                headers: { 'Authorization': 'Bearer ' + token },
                body: formData
            });

            const data = await res.json();
            document.getElementById('out').innerText = JSON.stringify(data, null, 2);
            alert(data.message);

            // –ï—Å–ª–∏ –≤—Å—ë –æ–∫, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–≤–æ–π —Å–ø–∏—Å–æ–∫ –∫–Ω–∏–≥
            if (data.status === 'success') getMyBooks();
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏ —Ç–µ–∫—Å—Ç–∞ (—ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–≤—ã—á–µ–∫)
        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        // –§—É–Ω–∫—Ü–∏—è 7: –î–∞—Ç—å –¥–æ—Å—Ç—É–ø
        async function grantAccess() {
            const token = localStorage.getItem('token');
            const guestId = document.getElementById('guestId').value;

            if (!token) return alert('–ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è!');
            if (!guestId) return alert('–í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞!');

            const res = await fetch('api.php?method=grant_access', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                body: JSON.stringify({ guest_id: guestId })
            });

            const data = await res.json();
            document.getElementById('out').innerText = JSON.stringify(data, null, 2);
            alert(data.message);
        }

        // –§—É–Ω–∫—Ü–∏—è 8: –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—É–∂–∏–µ –∫–Ω–∏–≥–∏
        async function viewOtherLibrary() {
            const token = localStorage.getItem('token');
            const ownerId = document.getElementById('ownerId').value;

            if (!token) return alert('–ù—É–∂–Ω–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è!');

            const res = await fetch(`api.php?method=get_other_books&owner_id=${ownerId}`, {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token }
            });

            const data = await res.json();
            document.getElementById('out').innerText = JSON.stringify(data, null, 2);

            const listDiv = document.getElementById('otherLibraryList');
            listDiv.innerHTML = '';

            if (data.status === 'success') {
                listDiv.innerHTML = `<strong>–ö–Ω–∏–≥–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ID ${ownerId}:</strong><br>`;
                data.books.forEach(book => {
                    listDiv.innerHTML += `${book.title}<br>`;
                });
            } else {
                listDiv.innerHTML = `<span style="color:red"> ${data.message}</span>`;
            }
        }
    </script>
</body>
</html>