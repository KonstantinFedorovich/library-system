<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Library API Dashboard</title>
    <style>
        :root { --primary: #bc6c25; --success: #606c38; --bg: #fefae0; --card: #faedcd; --text: #283618; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: var(--text); padding: 20px; max-width: 1000px; margin: 0 auto; }
        h1 { text-align: center; color: #555555; margin-bottom: 30px; }
        h3 { margin-top: 0; color: #555; border-bottom: 2px solid #eee; padding-bottom: 10px; }

        /* –°–µ—Ç–∫–∞ */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; }
        .card { background: var(--card); padding: 20px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }

        /* –ü–æ–ª—è –∏ –∫–Ω–æ–ø–∫–∏ */
        input, textarea, select { width: 100%; padding: 10px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; transition: 0.2s; margin-top: 5px; }

        .btn-blue { background: var(--primary); color: white; }
        .btn-blue:hover { background: #3046b5; }
        .btn-green { background: #10b981; color: white; }
        .btn-green:hover { background: #059669; }
        .btn-orange { background: #f59e0b; color: white; }
        .btn-purple { background: #8b5cf6; color: white; }

        /* –ö–æ–Ω—Å–æ–ª—å */
        .console-box { background: #1e1e2e; color: #a6accd; padding: 20px; border-radius: 12px; margin-top: 30px; min-height: 150px; font-family: monospace; overflow-x: auto; }
        .status-bar { margin-top: 10px; font-size: 0.9em; color: #666; text-align: right; }
        #savedToken { font-weight: bold; color: var(--primary); }
    </style>
</head>
<body>

<h1>üìö Library API Dashboard</h1>

<div class="grid">
    <div class="card">
        <h3>üë§ –í—Ö–æ–¥ / –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
        <input type="text" id="login" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="pass" placeholder="–ü–∞—Ä–æ–ª—å">
        <div style="display: flex; gap: 10px;">
            <button class="btn-green" onclick="sendAuth('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button class="btn-blue" onclick="sendAuth('login')">–í–æ–π—Ç–∏</button>
        </div>
        <button class="btn-blue" style="background: #6c757d; margin-top: 10px;" onclick="sendAuth('get_users')">üë• –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö —é–∑–µ—Ä–æ–≤</button>
    </div>

    <div class="card">
        <h3>üìñ –°–æ–∑–¥–∞—Ç—å –∫–Ω–∏–≥—É</h3>
        <input type="text" id="bookTitle" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏">
        <textarea id="bookText" rows="3" placeholder="–¢–µ–∫—Å—Ç –∫–Ω–∏–≥–∏..."></textarea>
        <small>–ò–ª–∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª .txt:</small>
        <input type="file" id="bookFile" accept=".txt">
        <button class="btn-green" onclick="createBook()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤ –ë–î</button>
    </div>

    <div class="card">
        <h3>üìö –ú–æ–∏ –∫–Ω–∏–≥–∏</h3>
        <button class="btn-blue" onclick="getMyBooks()">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        <div id="booksList" style="margin-top: 15px; max-height: 200px; overflow-y: auto;"></div>
    </div>

    <div class="card">
        <h3>üîç –ü–æ–∏—Å–∫ Google Books</h3>
        <input type="text" id="googleQuery" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ">
        <button class="btn-orange" onclick="searchGoogle()">–ù–∞–π—Ç–∏ –≤ Google</button>
        <div id="googleResults" style="margin-top: 10px;"></div>
    </div>

    <div class="card">
        <h3>ü§ù –°–æ—Ü–∏–∞–ª—å–Ω–∞—è —Å–µ—Ç—å</h3>
        <input type="number" id="guestId" placeholder="ID –¥—Ä—É–≥–∞ (–∫–æ–º—É –¥–∞—Ç—å –¥–æ—Å—Ç—É–ø)">
        <button class="btn-purple" onclick="grantAccess()">üîì –û—Ç–∫—Ä—ã—Ç—å –¥–æ—Å—Ç—É–ø</button>
        <hr style="border: 0; border-top: 1px solid #eee; margin: 15px 0;">
        <input type="number" id="ownerId" placeholder="ID –≤–ª–∞–¥–µ–ª—å—Ü–∞ (—á—å–µ —Å–º–æ—Ç—Ä–∏–º)">
        <button class="btn-purple" style="background: #7c3aed;" onclick="viewOtherLibrary()">üëÄ –°–º–æ—Ç—Ä–µ—Ç—å —á—É–∂–æ–µ</button>
        <div id="otherLibraryList" style="margin-top: 10px;"></div>
    </div>
</div>

<div class="console-box">
    <div style="color: #666; margin-bottom: 5px;">// –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:</div>
    <pre id="out">–û–∂–∏–¥–∞–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏–π...</pre>
</div>
<div class="status-bar">
    üîë –¢–æ–∫–µ–Ω: <span id="savedToken">–ù–µ—Ç</span>
</div>

<script>
    // --- API –õ–û–ì–ò–ö–ê ---

    async function sendAuth(method) {
        const login = document.getElementById('login').value;
        const pass = document.getElementById('pass').value;
        callApi(`api.php?method=${method}`, 'POST', { login, password: pass });
    }

    async function createBook() {
        const token = localStorage.getItem('token');
        if (!token) return alert('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞!');

        const formData = new FormData();
        formData.append('title', document.getElementById('bookTitle').value);
        formData.append('text', document.getElementById('bookText').value);
        const file = document.getElementById('bookFile').files[0];
        if (file) formData.append('book_file', file);

        // –û—Ç–ø—Ä–∞–≤–∫–∞ —Å FormData
        const res = await fetch(`api.php?method=create_book&token=${token}`, {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token },
            body: formData
        });
        showResult(await res.json());
    }

    async function getMyBooks() {
        callApi('api.php?method=get_books', 'GET', null, (data) => {
            const list = document.getElementById('booksList');
            list.innerHTML = '';
            data.books.forEach(b => {
                list.innerHTML += `<div style="padding:5px; border-bottom:1px solid #eee;">üìò <b>${b.title}</b> (ID: ${b.id}) <button onclick="openBook(${b.id})" style="width:auto; padding:2px 8px; font-size:0.8em;">–ß–∏—Ç–∞—Ç—å</button></div>`;
            });
        });
    }

    async function openBook(id) {
        callApi(`api.php?method=get_book&id=${id}`, 'GET');
    }

    async function searchGoogle() {
        const q = document.getElementById('googleQuery').value;
        callApi(`api.php?method=search_external&q=${q}`, 'GET', null, (data) => {
            const list = document.getElementById('googleResults');
            list.innerHTML = '';
            data.items.forEach(b => {
                list.innerHTML += `<div style="margin-bottom:10px; padding:5px; background:#f0f0f0; border-radius:4px;">
                    <b>${b.title}</b><br><small>${b.authors.join(', ')}</small>
                    <button onclick="saveFromGoogle('${escapeHtml(b.title)}', '${escapeHtml(b.description)}')" style="font-size:0.8em; background:#4cc9f0;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>`;
            });
        });
    }

    async function saveFromGoogle(title, desc) {
        const token = localStorage.getItem('token');
        if (!token) return alert('–ù–µ—Ç —Ç–æ–∫–µ–Ω–∞!');
        const formData = new FormData();
        formData.append('title', title);
        formData.append('text', desc);

        const res = await fetch(`api.php?method=create_book&token=${token}`, {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token },
            body: formData
        });
        showResult(await res.json());
    }

    async function grantAccess() {
        const guestId = document.getElementById('guestId').value;
        callApi('api.php?method=grant_access', 'POST', { guest_id: guestId });
    }

    async function viewOtherLibrary() {
        const ownerId = document.getElementById('ownerId').value;
        callApi(`api.php?method=get_other_books&owner_id=${ownerId}`, 'GET', null, (data) => {
            const list = document.getElementById('otherLibraryList');
            list.innerHTML = '';
            if(data.books) {
                data.books.forEach(b => list.innerHTML += `<div>üìô ${b.title}</div>`);
            }
        });
    }

    // --- –£–¢–ò–õ–ò–¢–´ ---

    async function callApi(url, method, body = null, callback = null) {
        const token = localStorage.getItem('token');
        const headers = { 'Content-Type': 'application/json' };
        if (token) headers['Authorization'] = 'Bearer ' + token;

        const options = { method, headers };
        if (body) options.body = JSON.stringify(body);

        try {
            const res = await fetch(url, options);
            const data = await res.json();
            showResult(data);
            if (data.token) {
                localStorage.setItem('token', data.token);
                document.getElementById('savedToken').innerText = '–ï—Å—Ç—å';
            }
            if (callback && data.status === 'success') callback(data);
        } catch (e) {
            document.getElementById('out').innerText = '–û—à–∏–±–∫–∞: ' + e.message;
        }
    }

    function showResult(data) {
        document.getElementById('out').innerText = JSON.stringify(data, null, 2);
    }

    function escapeHtml(text) {
        if (!text) return "";
        return text.replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    window.onload = () => {
        if(localStorage.getItem('token')) document.getElementById('savedToken').innerText = '–ï—Å—Ç—å';
    }
</script>

</body>
</html>